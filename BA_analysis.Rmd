---
title: "BA_analysis"
author: "Sigrid Agersnap Bom Nielsen"
date: "18/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
pacman::p_load(tidyverse, lme4, sjmisc, lmerTest, patchwork, sjPlot)
```

- Shortcuts
shift + control + option + M = ændr samme value flere steder i samme chunk

```{r testing function + for loop}

file_name = 'df_epochs_aud_neg0.csv'
data <- read_csv(paste0("data_frames/",file_name))

epochs = unique(data$epoch)

# get correct time interval, from 0 - 7 seconds
data <- data %>%
  filter(
    time < 0
    #time >= 0 & time <= 7000
  )# %>% 
  # delete first two columns by col name
  select(
    -c('...1', 'time')
  )

df = data.frame()

# for loop 
for (epoch_no in epochs){
  d = data %>% filter(epoch == epoch_no)
  
  cond = d$condition[1]
  
  d <- d %>% 
  select(
    -c(condition)
  )

  d = colMeans(d)
  d <- d %>% t() %>% data.frame
  
  d <- d %>% mutate(
  subject = str_extract(file_name, "\\d+"),
  cond = cond
  )

  df = rbind(df, d)
}


d <- d1 %>% 
  select(
    -c(condition)
  )

  )
d_test <- colMeans(d)

d_test <- d_test %>% t() %>% data.frame


test <- d_test %>% mutate(
  subject = str_extract(file_name, "\\d+")
  )

```
# Get data

## Load data and calculate means

```{r function}
load_data <- function(file_name){
  print(file_name)
  df_temp = data.frame()
  
  data <- read_csv(paste0("data_frames/",file_name))
  
  epochs = unique(data$epoch)
  
  # get correct time interval, from 0 - 7 seconds
  data <- data %>%
    filter(
      time >= 0 & time <= 7000
    ) %>% 
    # delete first two columns by col name
    select(
      -c('...1', 'time')
  )
  
  # for loop 
  for (epoch_no in epochs){
    d = data %>% filter(epoch == epoch_no)
    
    cond = d$condition[1]
    
    d <- d %>% 
    select(
      -c(condition)
    )
  
    d = colMeans(d)
    d <- d %>% t() %>% data.frame
    
    d <- d %>% mutate(
    subject = str_extract(file_name, "\\d+"),
    cond = cond
    )

    df_temp = rbind(df_temp, d)
  }
  
  return(df_temp)
}

file_name = 'df_epochs_aud_neg0.csv'

```

```{r loop through function - df_full}
# loop through all dataframes
df = list.files(path = 'data_frames/', pattern = 'csv') %>% 
  purrr::map_df(load_data)
```

```{r rearranging cols - df_full}

df_p <- df %>% select(
  c(cond, subject)
)

df_test <- df %>% 
  select(
    -c(cond, subject)
  )

df <- cbind(df_p, df_test)

df <- df_pretty %>% 
  mutate(
    subject = as.factor(subject)
  )
```

```{r write to csv df_full}
write_csv(df, "df_full.csv")
```

## Load baseline data - to check model

```{r baseline function}

load_data_baseline <- function(file_name){
  print(file_name)
  df_temp = data.frame()
  
  data <- read_csv(paste0("data_frames/",file_name))
  
  epochs = unique(data$epoch)

  
  # get correct time interval, from 0 - 7 seconds
  data <- data %>%
    filter(
      time < 0
    )
  # saving time for later to check  
  time_stamp = mean(data$time)
  
  data <- data %>% 
    #print(time) %>% 
    # delete first two columns by col name
    select(
      -c('...1', 'time')
  )
  
  # for loop 
  for (epoch_no in epochs){
    print(file_name)
    d = data %>% filter(epoch == epoch_no)
    
    cond = d$condition[1]
    
    d <- d %>% 
    select(
      -c(condition)
    )
  
    d = colMeans(d)
    d <- d %>% t() %>% data.frame
    
    d <- d %>% mutate(
    subject = str_extract(file_name, "\\d+"),
    cond = cond,
    )

    df_temp = rbind(df_temp, d)
  }
  
  return(df_temp)
}
```

```{r loop through baseline function}
# loop through all dataframes
df_baseline = list.files(path = 'data_frames/', pattern = 'csv') %>% 
  purrr::map_df(load_data_baseline)
# tager < 10 min at køre
# check, den vælger faktisk de negative 'time' værdier..
```

```{r rearranging cols - df_baseline}

df_cs <- df_baseline %>% select(
  c(cond, subject)
)

df_no_cs <- df_baseline %>% 
  select(
    -c(cond, subject)
  )

df_baseline <- cbind(df_cs, df_no_cs)

df_baseline <- df_baseline %>% 
  mutate(
    subject = as.factor(subject)
  )
```

```{r write to csv df_baseline}
write_csv(df_baseline, "df_baseline.csv")
```

# Rearranging dataframes (H1, aud vs. vis)
## 'Real' data rearrange

```{r pivot longer}
df_long <- df %>% 
  pivot_longer(
    cols = contains('hbo') | contains ('hbr'),
    names_to = 'cha_name',
    values_to = 'theta'
  )
```

```{r make columns}
# make different columns
df_long <- df_long %>% mutate(
  chroma = ifelse(grepl('hbo',cha_name), 'hbo', 'hbr'), 
  trial = ifelse(grepl('Auditory',cond), 'aud_stim', 'vis_stim')
)
```

```{r creating ROIs}
# creating ROIs
df_long <- df_long %>% mutate(
  ROI = ifelse(
    # visual ROIs
    grepl('S15_D14', cha_name) | 
    grepl('S15_D15', cha_name) |
      
    grepl('S14_D14', cha_name) |
    grepl('S14_D13', cha_name) |
      
    grepl('S16_D14', cha_name) |
    grepl('S16_D13', cha_name) |
    grepl('S16_D15', cha_name) |
    grepl('S16_D16', cha_name) |
      
    grepl('S29_D13', cha_name) |
    grepl('S29_D16', cha_name) |
    grepl('S29_D28', cha_name) |
      
    grepl('S31_D15', cha_name) |
    grepl('S31_D16', cha_name) |
    grepl('S31_D30', cha_name) |
      
    grepl('S30_D16', cha_name) |
    grepl('S30_D28', cha_name) |
    grepl('S30_D30', cha_name) |
    grepl('S30_D29', cha_name) |
      
    grepl('S27_D28', cha_name) |
    grepl('S27_D29', cha_name) |
      
    grepl('S32_D30', cha_name) |
    grepl('S32_D29', cha_name)
  , 'vis', 'temp'),
  
  ROI = ifelse(
    # auditory ROIs
    grepl('S7_D6', cha_name) | 
    grepl('S7_D8', cha_name) | 
      
    grepl('S9_D6', cha_name) |
    grepl('S9_D8', cha_name) |
    grepl('S9_D10', cha_name) |
      
    grepl('S11_D8', cha_name) |
    grepl('S11_D10', cha_name) |
    grepl('S11_D11', cha_name) |
      
    grepl('S13_D10', cha_name) |
    grepl('S13_D11', cha_name) |
    grepl('S13_D12', cha_name) |
      
    grepl('S22_D21', cha_name) |
    grepl('S22_D23', cha_name) |
      
    grepl('S24_D21', cha_name) |
    grepl('S24_D23', cha_name) |
    grepl('S24_D25', cha_name) |
      
    grepl('S26_D23', cha_name) |
    grepl('S26_D25', cha_name) |
    grepl('S26_D26', cha_name) |
      
    grepl('S28_D26', cha_name) |
    grepl('S28_D25', cha_name) |
    grepl('S28_D27', cha_name)
  , 'aud', ROI)
  )
```

```{r remove temp ROIs}
# removing irrelevant ROIs
df_long <- df_long %>% 
  filter(
    ROI != 'temp'
  )

# change classes
df_long <- df_long %>% 
  mutate(
    chroma = as.factor(chroma),
    trial= as.factor(trial),
    ROI = as.factor(ROI)
  )

# separate hbo and hbr
df_long_hbo <- df_long %>% 
  filter(chroma == 'hbo')

df_long_hbr <- df_long %>% 
  filter(chroma == 'hbr')
```


```{r write to csv}
write_csv(df_long, 'df_hyp1.csv')
```

## BASELINE rearrange
```{r df_long_baseline}

df_long_baseline <- df_baseline %>% 
  pivot_longer(
    cols = contains('hbo') | contains ('hbr'),
    names_to = 'cha_name',
    values_to = 'theta'
  )

#make columns
# make different columns
df_long_baseline <- df_long_baseline %>% mutate(
  chroma = ifelse(grepl('hbo',cha_name), 'hbo', 'hbr'), 
  trial = ifelse(grepl('Auditory',cond), 'aud', 'vis')
)

# creating ROIs
df_long_baseline <- df_long_baseline %>% mutate(
  ROI = ifelse(
    # visual ROIs
    grepl('S15_D14', cha_name) | 
    grepl('S15_D15', cha_name) |
      
    grepl('S14_D14', cha_name) |
    grepl('S14_D13', cha_name) |
      
    grepl('S16_D14', cha_name) |
    grepl('S16_D13', cha_name) |
    grepl('S16_D15', cha_name) |
    grepl('S16_D16', cha_name) |
      
    grepl('S29_D13', cha_name) |
    grepl('S29_D16', cha_name) |
    grepl('S29_D28', cha_name) |
      
    grepl('S31_D15', cha_name) |
    grepl('S31_D16', cha_name) |
    grepl('S31_D30', cha_name) |
      
    grepl('S30_D16', cha_name) |
    grepl('S30_D28', cha_name) |
    grepl('S30_D30', cha_name) |
    grepl('S30_D29', cha_name) |
      
    grepl('S27_D28', cha_name) |
    grepl('S27_D29', cha_name) |
      
    grepl('S32_D30', cha_name) |
    grepl('S32_D29', cha_name)
  , 'vis', 'temp'),
  
  ROI = ifelse(
    # auditory ROIs
    grepl('S7_D6', cha_name) | 
    grepl('S7_D8', cha_name) | ## FEHL FUNDET- skal være S7 D6 og S7 D8
      
    grepl('S9_D6', cha_name) |
    grepl('S9_D8', cha_name) |
    grepl('S9_D10', cha_name) |
      
    grepl('S11_D8', cha_name) |
    grepl('S11_D10', cha_name) |
    grepl('S11_D11', cha_name) |
      
    grepl('S13_D10', cha_name) |
    grepl('S13_D11', cha_name) |
    grepl('S13_D12', cha_name) |
      
    grepl('S22_D21', cha_name) |
    grepl('S22_D23', cha_name) |
      
    grepl('S24_D21', cha_name) |
    grepl('S24_D23', cha_name) |
    grepl('S24_D25', cha_name) |
      
    grepl('S26_D23', cha_name) |
    grepl('S26_D25', cha_name) |
    grepl('S26_D26', cha_name) |
      
    grepl('S28_D26', cha_name) |
    grepl('S28_D25', cha_name) |
    grepl('S28_D27', cha_name)
  , 'aud', ROI)
  )

# remove temp ROIs
# removing irrelevant ROIs
df_long_baseline <- df_long_baseline %>% 
  filter(
    ROI != 'temp'
  )

# change classes
df_long_baseline <- df_long_baseline %>% 
  mutate(
    chroma = as.factor(chroma),
    trial= as.factor(trial),
    ROI = as.factor(ROI)
  )

# separate hbo and hbr
df_long_baseline_hbo <- df_long_baseline %>% 
  filter(chroma == 'hbo')

df_long_baseline_hbr <- df_long_baseline %>% 
  filter(chroma == 'hbr')
```

# H1
## H1 real data model

```{r models}
# null model
m0 <- lmer(theta ~ 1 + (1|subject) + (1|cha_name), df_long_hbo, REML = F)
#summary(m0)

m1 <- lmer(theta ~ ROI + (1|subject) + (1|cha_name), df_long_hbo, REML = F)
#summary(m1)

m2 <- lmer(theta ~ ROI + trial + (1|subject) + (1|cha_name), df_long_hbo, REML = F)
#summary(m2)

m3 <- lmer(theta ~ ROI*trial + (1|subject) + (1|cha_name), df_long_hbo, REML = F)
#summary(m3)

anova(m0, m1, m2, m3)

summary(m3)

pacman::p_load(sjPlot)
tab_model(m3)
```


```{r r-squared}
pacman::p_load(MuMIn, piecewiseSEM)
MuMIn::r.squaredGLMM(m3)

# Store in SEM list
modelList <- psem(m3)
summary(modelList)

test <- piecewiseSEM::sem.model.fits(m3)

# R squared marginal: the variance explained by the fixed effects
# R squared conditional the variance explained by the entire model 
```
### H1 Hbo models real data
REML = F: Model 1 og model 3 er significant. Dvs. main effect af ROI og interaction af ROI og trial type.
REML = T: M1 og m3 er significant, dvs. main effect af ROI og interaction effect af ROI og trial. 

Kører med REML = F. 

### H1 Hbr models real data 
REML = F: Model 2 and model 3 is significant at p< .05. Dvs. main affect af ROI og trial+ interaction effect af ROI og trial. 

## Assumptions check 

```{r assumptions check}
# checking assumptions with diagnostic plots
qqnorm(resid(m3))
plot(m3)
```
Hbo: Looks good 
Hbr: Looks worse, but still relatively okay....

## Post-hoc analysis
```{r emmeans}
# emm_options(lmerTest.limit = 10854)
# emm_options(disable.pbkrtest = TRUE)
emm_roi <- emmeans(m4, pairwise ~ ROI)
emm_roi_c <- emm_roi[[2]]
emm_trial <- emmeans(m4, pairwise ~ trial)
emm_trial_c <- emm_trial[[2]]

#Time by deviant interaction
emm_roi.trial <- emmeans(m4, pairwise ~ ROI | trial)
IC_roi.trial <- contrast(emm_roi.trial[[1]], method = "pairwise")
emm_trial.roi <- emmeans(m4, pairwise ~ trial | ROI)
IC_trial.roi <- contrast(emm_trial.roi[[1]], method = "pairwise")

# rbind(emm_rc, emm_dc, IC_r.d[1:4], IC_d.r[1:12], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "none")
rbind(IC_roi.trial)

rbind(IC_trial.roi)

# IC_r.d[1:4]
# IC_d.r[1:12]
confint(rbind(IC_roi.trial))
# IC_d.r[c(1,3,7,9)]
IC_IC_trial.roi <- contrast(emm_trial.roi[[1]], interaction = c("pairwise", "consec"), by = NULL)
rbind(IC_IC_trial.roi)
confint(rbind(IC_IC_trial.roi))

```
### H1 Hbo EMM real data
Significant estimated marginal means:

 trial    contrast  estimate    SE  df z.ratio p.value
 aud_stim aud - vis     1.08 0.284 Inf   3.809  0.0003

Dvs. i auditory trials er der significant forskel i auditory og visual cortex på p<.001

-  vis aud_stim - vis_stim   -0.497 0.204 Inf  -2.441  0.0293
I visual cortex er der significant forskel af auditory og visual trials på p <.05.


### H1 Hbr EMM real data
Significant estimated marginal means:
-  vis aud_stim - vis_stim -0.19900 0.0633 Inf  -3.142  0.0034
I visual cortex er der signifikant forskel i aktiviteten udløst af visual og auditory trials på p <.01.

## H1 Plots Hbo + Hbr real data

```{r best plots, fig.width=5, fig.height= 2.5}
# hbo
p1 <- df_long_hbo %>% 
    group_by(
  ROI, trial
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = trial)) + 
  coord_cartesian(ylim = c(0, 2)) + 
  scale_x_discrete(
    name = '', labels = c('auditory cortices', 'visual cortex')
  ) +
  labs(
    title = 'A) Signal across ROI and trial type', 
    subtitle = 'Oxygenated hemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu))) + 
  scale_color_discrete(
    name = '',
    labels = c(
      'Auditory stimuli', 'Visual stimuli'
    )
  ) + theme(legend.position = 'none',
            text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            legend.text = element_text(size= 12)
            )
  
  
# hbr
p2 <- df_long_hbr %>% 
    group_by(
  ROI, trial
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = trial)) + 
  coord_cartesian(ylim = c(0, 2)) + 
  scale_x_discrete(
    name = '', labels = c('auditory cortices', 'visual cortex')
  ) +
  labs(
    subtitle = 'Deoxygenated hemoglobin (HbR)', # signal across ROIs and type of trial',
    y = '') + #theta ()') + 
  scale_color_discrete(
    name = '',
    labels = c(
      'Auditory stimuli', 'Visual stimuli'
    )
  )  +theme(text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            legend.text = element_text(size= 12)
            )

(p1 + p2)
```
```{r}
df_long_hbo %>% 
    group_by(
  ROI, trial
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = ROI) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = ROI)) + 
  coord_cartesian(ylim = c(0, 2)) + 
  scale_x_discrete(
    name = '', labels = c('auditory stimuli', 'visual stimuli')
  ) +
  labs(
    title = 'Change in signal across ROIs, trial type and chroma', 
    subtitle = 'Oxygenated hemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu))) + 
  scale_color_discrete(
    name = '',
    labels = c(
      'Auditory cortices', 'Visual cortex'
    )
  ) 
```

```{r individual traces plots, fig.width=5, fig.height = 4}
# testing sub rep plot

# ROI på x-aksen
# AUDITORY TRIALS
p5 <- df_long_hbo %>% 
  filter(
    trial == 'aud_stim'
  ) %>% 
    group_by(
  ROI, trial, subject
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial, group = subject) +
  stat_summary(fun = 'mean', geom = 'point', size = 2) + 
    #stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = subject)) + 
    stat_summary(fun = 'mean', geom = 'line', color = 'black', size = 1, aes(group = trial)) + 

  #coord_cartesian(ylim = c(0, 2)) + 
  scale_x_discrete(
    name = '', labels = c('auditory cortices', 'visual cortex')
  ) +
  labs(
    title = 'Signal across ROIs and auditory trials', 
    subtitle = 'Oxygenated hemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu))
    ) + 
  scale_color_discrete(
    name = '',
    labels = c(
      'Auditory stimuli', 'Visual stimuli'
    )
  ) + theme(legend.position = 'none') #+ 
  facet_wrap(~trial, 
             labeller = 
               labeller(trial = 
                          c("aud_stim" = "Auditory trials",
                            "vis_stim" = "Visual trials"
                          )))
  
  # VISUAL TRIALS
  p6 <- df_long_hbo %>% 
  filter(
    trial == 'vis_stim'
  ) %>% 
    group_by(
  ROI, trial, subject
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial, group = subject) +
  stat_summary(fun = 'mean', geom = 'point', color = 'turquoise', size = 2) + 
    #stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = subject)) + 
    stat_summary(fun = 'mean', geom = 'line', color = 'black', size = 1, aes(group = trial)) + 

  #coord_cartesian(ylim = c(0, 2)) + 
  scale_x_discrete(
    name = '', labels = c('auditory cortices', 'visual cortex')
  ) +
  labs(
    title = 'Signal across ROIs and visual trials', 
    subtitle = 'Oxygenated hemoglobin (HbO)',
   y = expression('theta' ~ (Delta*mu*Mu))
    )  +
     theme(legend.position = 'none')
  #+ 
  scale_color_discrete(
    name = '',
    labels = c(
      'Auditory stimuli', 'Visual stimuli'
    ))
  
  p5 + p6
```



```{r individual traces plots, fig.width = 4}
# STIM på x-aksen
  
  # auditory cortices
 p11 <- df_long_hbo %>% 
  filter(
    ROI == 'vis'
  ) %>% 
    group_by(
  ROI, trial, subject
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = ROI, group = subject) +
  stat_summary(fun = 'mean', geom = 'point', size = 2) + 
    #stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = subject)) + 
    stat_summary(fun = 'mean', geom = 'line', color = 'black', size = 1, aes(group = ROI)) + 
  #coord_cartesian(ylim = c(0, 2)) + 
  #scale_x_discrete(
  #  name = '', labels = c('auditory cortices', 'visual cortex')
  #) +
  labs(
    title = 'Mean signal per subject across trial type', 
    subtitle = 'Visual cortex (Hbo)',
     y = expression('theta' ~ (Delta*mu*Mu))
  ) +
    theme(legend.position = 'none')
  
  # VISUAL TRIALS
  p12 <-  df_long_hbo %>% 
  filter(
    ROI == 'aud'
  ) %>% 
    group_by(
  ROI, trial, subject
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = ROI, group = subject) +
  stat_summary(fun = 'mean', geom = 'point',color = 'gray55', size = 2) + 
    #stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'turquoise', aes(group = subject)) + 
    stat_summary(fun = 'mean', geom = 'line', color = 'black', size = 1, aes(group = ROI)) + 
  #coord_cartesian(ylim = c(0, 2)) + 
  #scale_x_discrete(
  #  name = '', labels = c('auditory cortices', 'visual cortex')
  #) +
  labs(
   # title = 'Signal across trial type in visual cortex', 
    subtitle = 'Auditory cortices (Hbo)',
    y = expression('theta' ~ (Delta*mu*Mu))
  )+
    theme(legend.position = 'none')
  
  (p11 + p12)
```

## H1 baseline model

```{r models}
# null model
m0 <- lmer(theta ~ 1 + (1|subject) + (1|cha_name), df_long_baseline_hbr, REML = F)
#summary(m0)

m1 <- lmer(theta ~ ROI + (1|subject) + (1|cha_name), df_long_baseline_hbr, REML = F)
#summary(m1)

m2 <- lmer(theta ~ ROI + trial + (1|subject) + (1|cha_name), df_long_baseline_hbr, REML = F)
#summary(m2)

m3 <- lmer(theta ~ ROI*trial + (1|subject) + (1|cha_name), df_long_baseline_hbr, REML = F)
#summary(m3)

anova(m0, m1, m2, m3)

```
### Baseline hbo model
REML = F: m1 og m2 er significant. Men heldigvis ikke nogen interaction effect. 

### Baseline hbr model
REML = F: m3 er significant på p<.05....... dvs. interaction effect. pis. 

## H1 baseline assumptions
```{r assumptions check}
# checking assumptions with diagnostic plots
qqnorm(resid(m3))
plot(m3)
```
Hbr: Ser ikke super ud. men kunne være værre...

## H1 baseline posthoc

```{r emmeans}
# emm_options(lmerTest.limit = 10854)
# emm_options(disable.pbkrtest = TRUE)
emm_roi <- emmeans(m3, pairwise ~ ROI)
emm_roi_c <- emm_roi[[2]]
emm_trial <- emmeans(m3, pairwise ~ trial)
emm_trial_c <- emm_trial[[2]]

#Time by deviant interaction
emm_roi.trial <- emmeans(m3, pairwise ~ ROI | trial)
IC_roi.trial <- contrast(emm_roi.trial[[1]], method = "pairwise")
emm_trial.roi <- emmeans(m3, pairwise ~ trial | ROI)
IC_trial.roi <- contrast(emm_trial.roi[[1]], method = "pairwise")

# rbind(emm_rc, emm_dc, IC_r.d[1:4], IC_d.r[1:12], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "none")
rbind(IC_roi.trial)
rbind(IC_trial.roi)
````
Hbr: lille effect i auditory trials mellem auditory og visual cortex

trial contrast   estimate      SE  df z.ratio p.value
 aud   aud - vis -0.020744 0.00835 Inf  -2.484  0.0260

Men hvis man kigger på plottet, ser det ikke super overbevisende ud (altså, det er en ret lille effekt).

## H1 baseline plots

```{r baseline plotting}
# hbr
df_long_baseline_hbr %>% 
    group_by(
  ROI, trial
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = trial))+ 
  coord_cartesian(ylim = c(-.2, 1)) # læg mærke til skalaen
```

# H2
## Create dataframe
```{r create df_long2}
# FOR H3 
df_long2_start <- df_long # (must be done after pivot_longer)

# creating new columns
df_long2 <- df_long2_start %>% mutate(
  chroma = ifelse(grepl('hbo',cha_name), 'hbo', 'hbr'), 
  trial = ifelse(grepl('Auditory',cond), 'aud_stim', 'vis_stim'),
  intensity = ifelse(grepl('neg', cond), 'neg', 'temp'),
  intensity = ifelse(grepl('pos', cond), 'pos', intensity),
  intensity = ifelse(grepl('neu', cond), 'neu', intensity)
  )

# creating ROIs
df_long2 <- df_long2 %>% mutate(
  ROI = ifelse(
    # visual ROIs
    grepl('S15_D14', cha_name) | 
    grepl('S15_D15', cha_name) |
      
    grepl('S14_D14', cha_name) |
    grepl('S14_D13', cha_name) |
      
    grepl('S16_D14', cha_name) |
    grepl('S16_D13', cha_name) |
    grepl('S16_D15', cha_name) |
    grepl('S16_D16', cha_name) |
      
    grepl('S29_D13', cha_name) |
    grepl('S29_D16', cha_name) |
    grepl('S29_D28', cha_name) |
      
    grepl('S31_D15', cha_name) |
    grepl('S31_D16', cha_name) |
    grepl('S31_D30', cha_name) |
      
    grepl('S30_D16', cha_name) |
    grepl('S30_D28', cha_name) |
    grepl('S30_D30', cha_name) |
    grepl('S30_D29', cha_name) |
      
    grepl('S27_D28', cha_name) |
    grepl('S27_D29', cha_name) |
      
    grepl('S32_D30', cha_name) |
    grepl('S32_D29', cha_name)
  , 'vis', 'temp'),
  
  ROI = ifelse(
    # auditory ROIs
    grepl('S7_D6', cha_name) | 
    grepl('S7_D8', cha_name) | ## FEHL FUNDET- skal være S7 D6 og S7 D8
      
    grepl('S9_D6', cha_name) |
    grepl('S9_D8', cha_name) |
    grepl('S9_D10', cha_name) |
      
    grepl('S11_D8', cha_name) |
    grepl('S11_D10', cha_name) |
    grepl('S11_D11', cha_name) |
      
    grepl('S13_D10', cha_name) |
    grepl('S13_D11', cha_name) |
    grepl('S13_D12', cha_name) |
      
    grepl('S22_D21', cha_name) |
    grepl('S22_D23', cha_name) |
      
    grepl('S24_D21', cha_name) |
    grepl('S24_D23', cha_name) |
    grepl('S24_D25', cha_name) |
      
    grepl('S26_D23', cha_name) |
    grepl('S26_D25', cha_name) |
    grepl('S26_D26', cha_name) |
      
    grepl('S28_D26', cha_name) |
    grepl('S28_D25', cha_name) |
    grepl('S28_D27', cha_name)
  , 'aud', ROI),
  
  ROI = ifelse(
    # frontal ROIs
    grepl('S4_D4', cha_name) | 
      
    grepl('S2_D4', cha_name) |
    grepl('S2_D1', cha_name) |
      
    grepl('S3_D4', cha_name) |
    grepl('S3_D1', cha_name) |
    grepl('S3_D2', cha_name) |
      
    grepl('S5_D4', cha_name) |
    grepl('S5_D3', cha_name) |
      
    grepl('S1_D1', cha_name) |
    grepl('S1_D2', cha_name) |
    grepl('S1_D17', cha_name) |
      
    grepl('S6_D3', cha_name) |
    grepl('S6_D2', cha_name) |
    grepl('S6_D18', cha_name) |
      
    grepl('S17_D2', cha_name) |
    grepl('S17_D17', cha_name) |
    grepl('S17_D19', cha_name) |
      
    grepl('S19_D18', cha_name) |
    grepl('S19_D19', cha_name) |
      
    grepl('S18_D17', cha_name) |
    grepl('S18_D19', cha_name) |
      
    grepl('S20_D19', cha_name)
  , 'front', ROI)
  )

# removing irrelevant ROIs
df_long2 <- df_long2 %>% 
  filter(
    ROI != 'temp',
    ROI != 'front'
  )

# change classes
df_long2 <- df_long2 %>% 
  mutate(
    chroma = as.factor(chroma),
    trial= as.factor(trial),
    ROI = as.factor(ROI),
    intensity = as.factor(intensity)
  )

# separate hbo and hbr
df_long2_hbo <- df_long2 %>% 
  filter(chroma == 'hbo')

df_long2_hbr <- df_long2 %>% 
  filter(chroma == 'hbr')

```

```{r write to csv}
write_csv(df_long2, 'df_hyp2.csv')
```

## model intensity real data
```{r relevel}
# relevel in a really bad way but it works - neu, pos, neg
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'neu')
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'pos')
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'neu')

# relevel in a really bad way but it works - neu, pos, neg
df_long2_hbr$intensity <- relevel(df_long2_hbr$intensity, 'neu')
df_long2_hbr$intensity <- relevel(df_long2_hbr$intensity, 'pos')
df_long2_hbr$intensity <- relevel(df_long2_hbr$intensity, 'neu')
```


```{r df_long2_int modelling}
# null model
m0 <- lmer(theta ~ 1 + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)
#summary(m0)

m1 <- lmer(theta ~ intensity + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)
#summary(m1)

m2 <- lmer(theta ~ intensity + ROI + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)
#summary(m2)

m3 <- lmer(theta ~ intensity + ROI + trial + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)

m4 <- lmer(theta ~ trial + intensity*ROI + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)

m5 <- lmer(theta ~ trial*intensity + ROI*intensity + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)

m6 <- lmer(theta ~ trial*intensity + intensity*ROI + trial*ROI + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)

m7 <- lmer(theta ~ intensity*trial*ROI + (1|subject) + (1|cha_name), df_long2_hbo, REML = F)

anova(m0, m1, m2, m3, m4, m5, m6, m7)
```
### H2 hbo models real data
m1, m2, m4, m5 og m6 er signifikante. 
Dvs. main effect intensity, 
main effect af intensity og ROI, 
main effect af trial med interaction af intensity og ROI, 
interaction effect af trial og intensity, og interaction effect af ROI og intensity, 
3 to-vejs interactions, trial og intensity, intensity og ROI, og trial og ROI. 

Så det er nok mest ROI og intensity, der bærer det.. 

### H2 hbr models real data
m3, m5 og m6 er signifikante.
Dvs, main effect af intensity, ROI og trial,
2 x to-vejs interaction mellem trial og intensity, og ROI og intensity
3 x to-vejs interactions mellem trial og intensity, intensity og ROI, og trial og ROI.

# NEW MODELS
```{r new models! H1 + H2}
# null model
m0 <- lmer(theta ~ 1 + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

m1 <- lmer(theta ~ ROI + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

m2 <- lmer(theta ~ ROI + trial + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

m3 <- lmer(theta ~ ROI + trial + intensity + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

# H1
m4 <- lmer(theta ~ ROI*trial + intensity + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

m5 <- lmer(theta ~ ROI*trial + intensity*ROI + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

# H1 + H2
m6 <- lmer(theta ~ ROI*trial + intensity*ROI + trial*intensity + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)

m7 <- lmer(theta ~ intensity*trial*ROI + (1|subject) + (1|cha_name), df_long2_hbr, REML = F)
```


```{r new models! H1 + H2 test}
# null model
m0 <- lmer(theta ~ 1 + (1|subject), test, REML = F)

m1 <- lmer(theta ~ ROI + (1|subject), test, REML = F)

m2 <- lmer(theta ~ ROI + trial + (1|subject), test, REML = F)

m3 <- lmer(theta ~ ROI + trial + intensity + (1|subject), test, REML = F)

# H1
m4 <- lmer(theta ~ ROI*trial + intensity + (1|subject), test, REML = F)

m5 <- lmer(theta ~ ROI*trial + intensity*ROI + (1|subject), test, REML = F)

# H1 + H2
m6 <- lmer(theta ~ ROI*trial + intensity*ROI + trial*intensity + (1|subject), test, REML = F)

m7 <- lmer(theta ~ intensity*trial*ROI + (1|subject), test, REML = F)


```

```{r H1 + H2 anova}
anova(m0, m1, m2, m3, m4, m5, m6, m7)
tab_model(m6)
```

```{r model summary and R-squared}
MuMIn::r.squaredGLMM(m4)
MuMIn::r.squaredGLMM(m6)
MuMIn::r.squaredLR(m6)

summary(m6)
```

```{r H1 + H2 tab_model}
tab_model(m6)
```

```{r assumptions check}
qqnorm(resid(m6))
plot(m6)
```
Hbo real data:
Ser godt ud. 

Hbr real data:
Ser ok ud.

## Post-hoc analysis

```{r emmeans}
# emm_options(lmerTest.limit = 10854)
# emm_options(disable.pbkrtest = TRUE)
emm_roi <- emmeans(m6, pairwise ~ ROI)
emm_roi_c <- emm_roi[[2]]

emm_trial <- emmeans(m6, pairwise ~ trial)
emm_trial_c <- emm_trial[[2]]

emm_int <- emmeans(m6, pairwise ~ intensity)
emm_int_c <- emm_int[[2]]

# ROI by intensity interaction
emm_roi.int <- emmeans(m6, pairwise ~ ROI | intensity)
IC_roi.int <- contrast(emm_roi.int[[1]], method = "pairwise")

emm_int.roi <- emmeans(m6, pairwise ~ intensity | ROI)
IC_int.roi <- contrast(emm_int.roi[[1]], method = "pairwise")

# Intensity by trial interaction
emm_int.trial <- emmeans(m6, pairwise ~ intensity | trial)
IC_int.trial <- contrast(emm_int.trial[[1]], method = 'pairwise')

emm_trial.int <- emmeans(m6, pairwise ~ trial | intensity)
IC_trial.int <- contrast(emm_trial.int[[1]], method = "pairwise")

# ROI by trial interaction
emm_roi.trial <- emmeans(m6, pairwise ~ ROI | trial)
IC_roi.trial <- contrast(emm_roi.trial[[1]], method = "pairwise")

emm_trial.roi <- emmeans(m6, pairwise ~ trial | ROI)
IC_trial.roi <- contrast(emm_trial.roi[[1]], method = "pairwise")

# rbind(emm_rc, emm_dc, IC_r.d[1:4], IC_d.r[1:12], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "mvt")
# rbind(IC_r.d[1:4], adjust = "none")
rbind(IC_roi.int)
rbind(IC_int.roi)
rbind(IC_trial.int)
rbind(IC_int.trial)
rbind(IC_roi.trial)
rbind(IC_trial.roi)

# IC_r.d[1:4]
# IC_d.r[1:12]
confint(rbind(IC_roi.trial))
# IC_d.r[c(1,3,7,9)]
IC_IC_trial.roi <- contrast(emm_trial.roi[[1]], interaction = c("pairwise", "consec"), by = NULL)
rbind(IC_IC_trial.roi)
confint(rbind(IC_IC_trial.roi))
```

### H2 Hbo EMM real data
Significant estimated marginal means:

*int_ROI*
intensity contrast  estimate    SE  df z.ratio p.value
 neu       aud - vis    1.424 0.306 Inf   4.650  <.0001

Dvs. i trials med neutral intensity er der signifikant forskel mellem auditory og visual cortex på 1.4. Større aktivering af aud cortex. 

*ROI_int*
 ROI contrast  estimate    SE  df z.ratio p.value
 aud neu - neg  -0.6996 0.249 Inf  -2.810  0.0297
 aud neg - pos   0.7602 0.249 Inf   3.053  0.0136
 vis neu - neg  -1.4280 0.249 Inf  -5.736  <.0001
 vis neu - pos  -1.2502 0.249 Inf  -5.022  <.0001

 
I auditory cortex er der signifikant forskel på negative og neutral stimuli, hvor negativ stimuli har størt effect med en forskel på -0.7.
I auditory cortex er der signifkant forskel mellem negative og positive stimuli, hvor negativ har størst effect med en forskel på 0.8.
I visual cortex er der signifikant forskel mellem negative og neutral stimuli, hvor negative stimuli har størt effekt med en forskel på -1.4.
I visual cortex er der signifikant forskel mellem positive og neutral stimuli, hvor positive stimuli har størst effet (forskel på -1.3. )
 
 *trial_int*
 intensity contrast            estimate    SE  df z.ratio p.value
 neu       aud_stim - vis_stim   -0.598 0.249 Inf  -2.403  0.0487

I neutral stimuli trials, er der signifikant forskel mellem auditory og visual trials, hvor der er størst effekt af visuelle trials. Forskel på -.6. 

 *int_trial*
  trial    contrast  estimate    SE  df z.ratio p.value
 aud_stim neu - neg   -1.566 0.249 Inf  -6.289  <.0001
 aud_stim neu - pos   -0.806 0.249 Inf  -3.236  0.0073
 aud_stim neg - pos    0.760 0.249 Inf   3.053  0.0136
 
 
Ved auditory trials, er der signifikant forskel mellem både neg og neu stimuli (neg er størst), neg og pos stimuli (neg er størst) og neu og pos stimuli (pos er størst).

*roi_trial new*

 trial    contrast  estimate   SE  df z.ratio p.value
 aud_stim aud - vis    1.118 0.27 Inf   4.135  0.0001
 vis_stim aud - vis    0.371 0.27 Inf   1.370  0.3411

samme som i H1 - næsten magen til. Dvs. i auditory trials er der significant forskel i auditory og visual cortex på p<.001


*trial_roi new*
 ROI contrast            estimate    SE  df z.ratio p.value
 aud aud_stim - vis_stim    0.251 0.203 Inf   1.233  0.4351
 vis aud_stim - vis_stim   -0.497 0.203 Inf  -2.444  0.0290

samme som i H1 (næsten magen til, det er estimater).

I visual cortex er der significant forskel af auditory og visual trials på p <.05.
(større effekt men mindre sikker ift. H1)


### H2 Hbr EMM real data
Significant estimated marginal means:

*roi og intensity*
nothing

*intensity og trial*
intensity contrast            estimate     SE  df z.ratio p.value
 neu       aud_stim - vis_stim   -0.344 0.0756 Inf  -4.554  <.0001

I neutrale stimuli er der signifikant forskel mellem auditory og visual sitmuli, hvor visuelle stimuli har den største effekt (forskel på -0.3). Lille effekt.

 trial    contrast  estimate     SE  df z.ratio p.value
 aud_stim neg - neu   0.3412 0.0756 Inf   4.514  <.0001

I auditory trials er der signifikant forskel mellem negative og neutrale stimuli. forskel på 0.3 - lille effekt. 

*roi_trial*
 ROI contrast            estimate     SE  df z.ratio p.value
 aud aud_stim - vis_stim   -0.111 0.0437 Inf  -2.535  0.0225
 vis aud_stim - vis_stim   -0.111 0.0437 Inf  -2.535  0.0225

I både auditory og visual cortices er der significant forskel på visual og auditory trials. Her er det begge steder visuel stimuli der har den største effekt (forskel på -0.1.) ------ gælder ikke skal køres igen, men det er ikke relevant alligevel. 



```{r testing}
test <- aggregate(df_long2_hbo$theta, list(df_long2_hbo$subject, df_long2_hbo$ROI, df_long2_hbo$trial, df_long2_hbo$intensity, df_long2_hbo$epoch), FUN=mean) 


test <- test %>% 
  rename(
    subject = 'Group.1',
    ROI = 'Group.2',
    trial = 'Group.3',
    intensity = 'Group.4',
    epoch = 'Group.5',
    theta = x
  )


test <- test %>% 
  mutate(
    subject = as.factor(subject),
    ROI = as.factor(ROI),
    trial = as.factor(trial),
    intensity = as.factor(intensity)
  )
```


## plotting 
### intensity og ROI interaction

```{r, fig.width = 5}
# HbO
p9 <- df_long2_hbo %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-.5, 3)) + 
  scale_color_manual(name = "valence", labels = c("neutral", "negative", "positive"), values = c('black', 'red', 'blue')) +
  scale_x_discrete(name = '',labels = c('auditory cortices','visual cortex')) +
  labs(
    title = 'A) Signal across ROI and valence',
    subtitle = 'Oxyhemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu))
  ) + theme(legend.position = 'none',
            text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12)
            )

# HbR
p10 <- df_long2_hbr %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-0.5, 3)) + 
  scale_color_manual(
    name = "valence", 
    labels = c("neutral", "positive", "negative"), 
    values = c('black', 'blue', 'red')
    ) +
  scale_x_discrete(name = '',labels = c('auditory cortices','visual cortex')) +
  labs(
   # title = 'Theta across intensity of stimuli in both auditory and visual cortices/cortex',
    subtitle = 'Deoxyhemoglobin (HbR)',
    y = ''
  ) + theme(text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            legend.text = element_text(size= 12)
            )

p9+p10

````


### intensity*trial interaction 

```{r plot, fig.width = 5, fig.height= 4}
p7 <- df_long2_hbo %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-.5, 2.5)) + 
  scale_color_manual(name = "valence", labels = c("neutral", "negative", "postive"), values = c('black', 'red', 'blue')) +
  scale_x_discrete(name = '',labels = c('auditory trials','visual trials')) +
  labs(
    title = 'B) Signal across trial type and valence',
    subtitle = 'Oxyhemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu))
  ) + theme(legend.position = 'none',
            text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12)
            )

p8 <- df_long2_hbr %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-.5, 2.5)) + 
  scale_color_manual(name = "valence", labels = c("neutral","postive", "negative"), values = c('black', 'blue', 'red')) +
  scale_x_discrete(name = '',labels = c('auditory trials','visual trials')) +
  labs(
    #title = 'Theta across valence of stimuli in both auditory and visual trials',
    subtitle = 'Deoxyhemoglobin (HbR)',
    y = ''
  ) + theme(text = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            legend.text = element_text(size= 12)
            )

(p9 + p10) / (p7 + p8)
```

### trial*ROI interaction
```{r plot}
# trial by ROI
df_long2_hbo %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = trial, y = theta, color = ROI) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = ROI)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
   labs(
    title = 'Theta across ROIs and trial types'
  ) + 
  scale_color_manual(name = "ROI", 
                     labels = c("auditory cortices", "visual cortex"), 
                     values = c('red', 'blue')
                     ) +
  scale_x_discrete(name = 'trial types',labels = c('auditory trials','visual trials'))
 
# ROI by trial
df_long2_hbo %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = trial) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = trial)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
   labs(
    title = 'Theta across ROIs and trial types'
  ) +
  scale_color_manual(name = "trial type", 
                     labels = c("auditory trials", "visual trials"), 
                     values = c('red', 'blue')
                     ) +
  scale_x_discrete(name = 'ROI',labels = c('auditory cortices','visual cortex'))
```

### intensity three-levels

```{r df_long2_int relevel intensity}
# relevel in a really bad way but it works - neu, pos, neg
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'neu')
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'pos')
df_long2_hbo$intensity <- relevel(df_long2_hbo$intensity, 'neu')
```

```{r df_long2_int plotting intensity 3 levels, fig.width= 5, fig.height=5}
p3 <- df_long2_hbo %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
  scale_color_manual(name = "Intensity", labels = c("neutral", "positive", "negative"), values = c('black', 'blue', 'red')) +
  scale_x_discrete(name = 'ROI',labels = c('auditory cortices','visual cortex')) +
  labs(
    title = 'Signal across trial type, ROI, chroma and level of arousal',
    subtitle = 'Oxygenated hemoglobin (HbO)',
    y = expression('theta' ~ (Delta*mu*Mu)),
    x = ''
  ) + 
  facet_wrap(~trial, 
             labeller = 
               labeller(trial = 
                          c("aud_stim" = "Auditory trials",
                            "vis_stim" = "Visual trials"
                          ))) +
  theme(legend.position = 'none')



p4 <- df_long2_hbr %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
  scale_color_manual(name = "Arousal", labels = c("neutral", "positive", "negative"), values = c('black', 'blue', 'red')) +
  scale_x_discrete(name = 'ROI',labels = c('auditory cortices','visual cortex')) +
  labs(
  #  title = 'Theta across valence of stimuli in both auditory and visual trials for each ROI'
    subtitle = 'Deoxygenated hemoglobin (HbR)',
    y = expression('theta' ~ (Delta*mu*Mu)),
    x = ''
  ) + 
  facet_wrap(~trial, 
             labeller = 
               labeller(trial = 
                          c("aud_stim" = "Auditory trials",
                            "vis_stim" = "Visual trials"
                          ))) +
  theme(legend.position = 'bottom')


p3 / p4
```





### Patchwork
```{r H2 hbo + hbr patchwork, fig.width = 4, fig.height= 4}
p3 <- df_long2_hbo %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
  scale_color_manual(name = "Intensity", labels = c("neutral", "positive", "negative"), values = c('black', 'blue', 'red')) +
  scale_x_discrete(name = '',labels = c('auditory cortices','visual cortex')) +
  labs(
    title = 'Theta across valence of stimuli in both auditory and visual trials for each ROI',
    subtitle = 'Oxyhemoglobin (Hbo)',
    ylab = 'Theta (AU)'
  ) + 
  facet_wrap(~trial, 
             labeller = 
               labeller(trial = 
                          c("aud_stim" = "Auditory trials",
                            "vis_stim" = "Visual trials"
                          ))) #+
  #theme(legend.position == 'none')



p4 <- df_long2_hbr %>% 
  filter(
    ROI != 'front'
  #  ,intensity != 'neu'
  ) %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
  coord_cartesian(ylim = c(-.1, 3)) + 
  scale_color_manual(name = "Intensity", labels = c("neutral", "positive", "negative"), values = c('black', 'blue', 'red')) +
  scale_x_discrete(name = '',labels = c('auditory cortices','visual cortex')) +
  labs(
    #title = 'Theta across valence of stimuli in both auditory and visual trials for each ROI'
  subtitle = 'Deoxyhemoglobin (Hbr)',
  xlab = '',
  ylab = 'Theta (AU)'
    ) + 
  facet_wrap(~trial, 
             labeller = 
               labeller(trial = 
                          c("aud_stim" = "Auditory trials",
                            "vis_stim" = "Visual trials"
                          )))

p3/p4

```
 
 # Baseline H2
 maybe not necessary 
 
 
 
 # cleaned her til
```{r df_long2 plot valence}

df_long2_hbo %>% 
    group_by(
  ROI, trial, valence
  ) %>% 
  ggplot() +
  aes(
    x = valence, y = theta, color = trial) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = trial)) + 
  coord_cartesian(ylim = c(-.2, 2.5))


# other plot - from anova - main effect of valence
df_long2_hbo %>% 
    group_by(
  ROI, trial, valence
  ) %>% 
  ggplot() +
  aes(
    x = valence, y = theta, color = valence) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = 1)) + 
  coord_cartesian(ylim = c(0, 2.5)) + 
  theme(legend.position = 'none')
```

```{r df_long2_int plotting intensity high_low}
df_long2_int_hbo %>% 
    group_by(
  ROI, trial, intensity_high_low
  ) %>% 
  ggplot() +
  aes(
    x = ROI, y = theta, color = intensity_high_low) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity_high_low)) + 
  coord_cartesian(ylim = c(-1, 3)) + 
  facet_wrap(~trial)
```


```{r}
df_long2_int_hbo %>% 
    group_by(
  ROI, trial, intensity
  ) %>% 
  ggplot() +
  aes(
    x = intensity, y = theta, color = intensity) +
  stat_summary(
    fun = 'mean', geom = 'point', size = 2) + 
    stat_summary(fun.data = "mean_se", geom = 'errorbar', width = .1) +
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = intensity)) + 
    stat_summary(fun = 'mean', geom = 'line', color = 'gray55', aes(group = 1)) + 
  coord_cartesian(ylim = c(0, 2.5)) + 
  scale_color_manual(values = c('#0000FF', '#00FF00','#FF0000')) +
  theme(legend.position = 'none') +
  scale_x_discrete(name = 'Valence',labels = c('neutral','positive', 'negative')) +
  labs(
    title = 'Signal across valence of stimuli'
  )

```

